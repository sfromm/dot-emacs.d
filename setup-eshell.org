#+TITLE: Emacs and Eshell
#+PROPERTY: header-args :tangle ~/.emacs.d/site-lisp/setup-eshell.el

* Eshell

Some useful references:

- [[https://www.gnu.org/software/emacs/manual/html_mono/eshell.html][Manual]]
- [[https://www.reddit.com/r/emacs/comments/1zkj2d/advanced_usage_of_eshell/][r/emacs Advanced usage of Eshell]]
- [[https://www.masteringemacs.org/article/complete-guide-mastering-eshell][Mastering Eshell]]
- [[http://www.howardism.org/Technical/Emacs/eshell-fun.html][Eschewing zshell for eshell]]

First off, set default method for [[https://www.gnu.org/software/tramp/][tramp]] to ssh:

#+BEGIN_SRC emacs-lisp
(setq tramp-default-method "ssh")
#+END_SRC

Now, let's go ahead and configure eshell:

#+BEGIN_SRC emacs-lisp
  (use-package eshell
    :commands (eshell eshell-command)
    :preface
    (use-package em-unix
      :defer t
      :config
      (unintern 'eshell/su nil)
      (unintern 'eshell/sudo nil))
    :init
    (progn
      (setq
        eshell-visual-commands '("less" "tmux" "htop" "top" "bash" "zsh" "fish" "docker")
        eshell-visual-subcommands '(("git" "log" "diff" "show"))
        )
      (evil-set-initial-state 'eshell-mode 'emacs))
    :config
    (progn
      (setq
        eshell-prompt-function (lambda ()
                                 (concat
                                   "┌─["
                                   (user-login-name) "@" (system-name)
                                   " 🗁 " (abbreviate-file-name (eshell/pwd))
                                   " 🕗 " (format-time-string "%b %d %H:%M" (current-time))
                                   "]\n"
                                   "└─>" (if (= (user-uid) 0) " # " " $ "))) )
      (add-hook 'eshell-mode-hook
        (lambda ()
          (eshell/alias "q" "exit")
          (eshell/alias "l" "ls -al")
          (eshell/alias "ll" "ls -al")
          (eshell/alias "e" "find-file \$1")
          (eshell/alias "ff" "find-file \$1")
          (eshell/alias "ee" "find-file-other-window \$1")
          (eshell/alias "gd" "magit-diff-unstaged")
          (eshell/alias "gds" "magit-diff-staged")
          (eshell/alias "gst" "magit-status")
          ))
      )
    )
#+END_SRC

The following comes from [[https://github.com/howardabrams/dot-files/blob/master/emacs-eshell.org][Howard Abrams]]:

#+BEGIN_SRC emacs-lisp
  (defun eshell-here ()
    "Opens up a new shell in the directory associated with the current buffer's file."
    (interactive)
    (let* ((parent (file-name-directory (buffer-file-name)))
            (height (/ (window-total-height) 3))
            (name (car (last (split-string parent "/" t)))))
      (split-window-vertically)
      (other-window 1)
      (eshell "new")
      (rename-buffer (concat "*eshell: " name "*"))
      (insert (concat "ls"))
      (eshell-send-input)))
  (global-set-key (kbd "C-!") 'eshell-here)
#+END_SRC

* Terminals

References on the subject of running terminals in Emacs:

- [[http://www.masteringemacs.org/article/running-shells-in-emacs-overview][Running Shells in Emacs]]

Set default shell to =bash=, make sure the initial state is =emacs= and
then provide helper function to launch =ansi-term=.

#+BEGIN_SRC emacs-lisp
  (setq explicit-shell-file-name "/bin/bash")
  (evil-set-initial-state 'term-mode 'emacs)
  (defun sf/terminal ()
    "Switch to terminal; launch if non-existent"
    (interactive)
    (if (get-buffer "*ansi-term*")
      (switch-to-buffer "*ansi-term*")
      (ansi-term "/bin/bash"))
    (get-buffer-process "*ansi-term*"))
#+END_SRC

Finally, offer module for use.

#+BEGIN_SRC emacs-lisp
(provide 'setup-eshell)
#+END_SRC

* License

This document is licensed under the GNU Free Documentation License
version 1.3 or later (http://www.gnu.org/copyleft/fdl.html).

#+BEGIN_SRC 
Copyright (C) 2017 Stephen Fromm

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3
or any later version published by the Free Software Foundation;
with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.

Code in this document is free software: you can redistribute it
and/or modify it under the terms of the GNU General Public
License as published by the Free Software Foundation, either
version 3 of the License, or (at your option) any later version.

This code is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.
#+END_SRC
